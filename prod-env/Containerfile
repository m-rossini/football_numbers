# Multi-stage production container for Express/TypeScript application
# Build stage: compile and prepare artifacts

FROM fedora:latest AS builder

RUN dnf update -y && \
    dnf install -y \
    nodejs \
    npm && \
    dnf clean all

WORKDIR /build

# Copy only essential files for build
COPY package*.json tsconfig.json ./
COPY src ./src

# Install dependencies and build
RUN npm ci && \
    npm run build

# Runtime stage: minimal production image
FROM fedora:latest

RUN dnf update -y && \
    dnf install -y \
    nodejs && \
    dnf clean all

WORKDIR /app

# Copy only compiled artifacts and dependencies from builder
COPY --from=builder /build/dist ./dist
COPY --from=builder /build/node_modules ./node_modules
COPY package.json .

# Non-root user for security (optional but recommended)
RUN useradd -m -u 1000 app && chown -R app:app /app
USER app

ENV NODE_ENV=production

EXPOSE 3000

CMD ["node", "dist/index.js"]
