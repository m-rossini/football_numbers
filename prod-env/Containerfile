# Multi-stage production container for Express/TypeScript application
# Build stage: compile and prepare artifacts

FROM fedora:latest AS builder

RUN dnf update -y && \
    dnf install -y \
    nodejs \
    npm && \
    dnf clean all

WORKDIR /build

# Copy only essential files for build
COPY package*.json tsconfig.json ./
COPY src ./src

# Install dependencies and build
RUN npm ci && \
    npm run build

# Runtime stage: minimal production image
FROM fedora:latest

RUN dnf update -y && \
    dnf install -y \
    nodejs && \
    dnf clean all

# Create non-root user first (before COPY)
RUN useradd -m -u 1000 app

WORKDIR /app

# Copy only compiled artifacts and dependencies from builder with ownership
COPY --from=builder --chown=app:app /build/dist ./dist
COPY --from=builder --chown=app:app /build/node_modules ./node_modules
COPY --chown=app:app package.json .

USER app

ENV NODE_ENV=production

EXPOSE 3000

CMD ["node", "dist/index.js"]
